name: Sync Brand Assets (Polling)

on:
  schedule:
    # Run daily at 8:00 UTC
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  check-and-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Website
        uses: actions/checkout@v4

      - name: Check for Updates
        id: check
        env:
          GH_TOKEN: ${{ secrets.BRAND_REPO_READ_TOKEN }}
        run: |
          # 1. Get Local Version
          LOCAL_VERSION=$(jq -r .version src/data/brand-version.json)
          echo "Current local version: $LOCAL_VERSION"

          # 2. Get Remote Version (Latest Release Tag)
          # We use the GitHub CLI to fetch the latest release tag from the brand repo
          REMOTE_VERSION=$(gh release view --repo bitcraft-apps/bitcraft-brand --json tagName -q .tagName)
          echo "Latest remote version: $REMOTE_VERSION"

          # 3. Compare
          # Normalize versions by removing leading 'v' if present
          LOCAL_CLEAN=${LOCAL_VERSION#v}
          REMOTE_CLEAN=${REMOTE_VERSION#v}

          echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT

          if [ "$LOCAL_CLEAN" == "$REMOTE_CLEAN" ]; then
            echo "Versions match. No update needed."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            echo "New version found!"
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "version=$REMOTE_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Download & Update Assets
        if: steps.check.outputs.update_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.BRAND_REPO_READ_TOKEN }}
          VERSION: ${{ steps.check.outputs.version }}
        run: |
          echo "Downloading assets for version $VERSION..."

          # Download the specific asset 'brand-bundle.zip' from the release
          gh release download "$VERSION" \
            --repo bitcraft-apps/bitcraft-brand \
            --pattern "*brand-bundle*.zip" \
            --dir temp-download

          # Prepare destination
          rm -rf public/brand
          mkdir -p public/brand

          # Unzip (assuming flat structure or handling internal folders)
          # Use find to locate the zip file regardless of the version suffix
          ZIP_FILE=$(find temp-download -name "*brand-bundle*.zip" | head -n 1)
          unzip -o "$ZIP_FILE" -d public/brand/

          # Clean up zip
          rm -rf temp-download

          # Update the local version file
          # We use a temp file to safely write JSON
          jq --arg v "$VERSION" '.version = $v' src/data/brand-version.json > temp.json && mv temp.json src/data/brand-version.json

      - name: Create Pull Request
        if: steps.check.outputs.update_needed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(brand): update assets to ${{ steps.check.outputs.version }}'
          branch: brand-update-${{ steps.check.outputs.version }}
          title: 'chore(brand): update assets to ${{ steps.check.outputs.version }}'
          body: |
            Automated brand asset update detected.

            **Old Version:** ${{ steps.check.outputs.local_version }} (implied)
            **New Version:** ${{ steps.check.outputs.version }}

            This PR was created automatically by the polling workflow.
          delete-branch: true
