---
/**
 * ThemeToggle component - toggles between light and dark mode
 * - Persists preference in localStorage
 * - Respects system preference on first visit
 * - Shows sun icon in dark mode (to switch to light), moon icon in light mode (to switch to dark)
 */
import Icon from './Icon.astro';
import { THEME_COLORS } from '../consts';
---

<button
  id="theme-toggle"
  type="button"
  class="p-2 rounded-md text-near-black dark:text-off-white hover:text-dark-olive dark:hover:text-white hover:bg-off-white dark:hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-dark-olive dark:focus:ring-off-white transition-colors duration-200"
  aria-label="Switch to dark mode"
  data-theme-light={THEME_COLORS.light}
  data-theme-dark={THEME_COLORS.dark}
>
  <!-- Sun icon - shown in dark mode (click to switch to light) -->
  <span class="hidden dark:block">
    <Icon name="sun" size="sm" />
  </span>
  <!-- Moon icon - shown in light mode (click to switch to dark) -->
  <span class="block dark:hidden">
    <Icon name="moon" size="sm" />
  </span>
</button>

<script>
  // Extend Window interface for TypeScript
  declare global {
    interface Window {
      __themeController?: AbortController;
    }
  }

  function initThemeToggle() {
    const button = document.getElementById('theme-toggle');
    if (!button) return;

    // Clean up previous listeners to prevent memory leaks on View Transitions
    window.__themeController?.abort();
    const controller = new AbortController();
    window.__themeController = controller;

    function updateAriaLabel(theme: 'light' | 'dark') {
      button!.setAttribute('aria-label', theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode');
    }

    function updateThemeColorMeta(theme: 'light' | 'dark') {
      const meta = document.querySelector('meta[name="theme-color"]');
      if (meta) {
        const color = theme === 'dark' 
          ? button!.dataset.themeDark 
          : button!.dataset.themeLight;
        if (color) meta.setAttribute('content', color);
      }
    }

    function setTheme(theme: 'light' | 'dark') {
      document.documentElement.classList.toggle('dark', theme === 'dark');
      document.documentElement.style.colorScheme = theme;
      updateAriaLabel(theme);
      updateThemeColorMeta(theme);
      try {
        localStorage.setItem('theme', theme);
      } catch {
        // localStorage unavailable - theme still works, just won't persist
      }
    }

    function toggleTheme() {
      const current = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
      const next = current === 'dark' ? 'light' : 'dark';
      setTheme(next);
    }

    // Set initial aria-label based on current theme
    const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    updateAriaLabel(currentTheme);

    button.addEventListener('click', toggleTheme, { signal: controller.signal });

    // Listen for system preference changes (only if user hasn't set a preference)
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    mediaQuery.addEventListener('change', (e) => {
      // Only update if user hasn't explicitly set a preference
      try {
        if (!localStorage.getItem('theme')) {
          setTheme(e.matches ? 'dark' : 'light');
        }
      } catch {
        // localStorage unavailable - use system preference
        setTheme(e.matches ? 'dark' : 'light');
      }
    }, { signal: controller.signal });
  }

  // Use astro:page-load which fires on initial load and View Transitions navigation
  document.addEventListener('astro:page-load', initThemeToggle);
</script>
