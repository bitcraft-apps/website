---
/**
 * Header component with responsive navigation
 * - Desktop: horizontal nav bar
 * - Mobile: hamburger menu with slide-down navigation
 */
import Logo from './Logo.astro';
import { NAV_ITEMS } from '../consts';
import { isActive } from '../utils/navigation';

const currentPath = Astro.url.pathname;
---

<header class="sticky top-0 z-50 bg-white border-b border-olive-drab shadow-sm">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      <!-- Logo -->
      <a href="/" class="flex-shrink-0">
        <Logo class="h-8 w-auto" />
      </a>

      <!-- Desktop Navigation -->
      <nav class="hidden md:flex space-x-8" aria-label="Main navigation">
        <ul class="flex space-x-8">
          {
            NAV_ITEMS.map((item) => (
              <li>
                <a
                  href={item.href}
                  class:list={[
                    'text-near-black hover:text-dark-olive transition-colors duration-200',
                    { 'text-dark-olive font-semibold': isActive(item.href, currentPath) },
                  ]}
                  aria-current={isActive(item.href, currentPath) ? 'page' : undefined}
                >
                  {item.label}
                </a>
              </li>
            ))
          }
        </ul>
      </nav>

      <!-- Theme Toggle Slot -->
      <div class="flex items-center">
        <slot name="theme-toggle" />
      </div>

      <!-- Mobile Menu Button -->
      <button
        id="mobile-menu-button"
        type="button"
        class="md:hidden p-2 rounded-md text-near-black hover:text-dark-olive hover:bg-off-white focus:outline-none focus:ring-2 focus:ring-inset focus:ring-dark-olive"
        aria-expanded="false"
        aria-controls="mobile-menu"
        aria-label="Open main menu"
      >
        <span class="sr-only">Open main menu</span>
        <svg
          class="hamburger-icon h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
        <svg
          class="close-icon hidden h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile Navigation Menu -->
  <nav
    id="mobile-menu"
    class="hidden md:hidden bg-white border-t border-olive-drab"
    aria-label="Mobile navigation"
  >
    <ul class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
      {
        NAV_ITEMS.map((item) => (
          <li>
            <a
              href={item.href}
              class:list={[
                'mobile-nav-link block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200',
                isActive(item.href, currentPath)
                  ? 'text-dark-olive bg-off-white'
                  : 'text-near-black hover:text-dark-olive hover:bg-off-white',
              ]}
              aria-current={isActive(item.href, currentPath) ? 'page' : undefined}
            >
              {item.label}
            </a>
          </li>
        ))
      }
    </ul>
  </nav>
</header>

<script>
  // Extend Window interface for TypeScript
  declare global {
    interface Window {
      __mobileMenuController?: AbortController;
    }
  }

  function initMobileMenu() {
    const button = document.getElementById('mobile-menu-button') as HTMLButtonElement | null;
    const menu = document.getElementById('mobile-menu') as HTMLElement | null;

    if (!button || !menu) return;

    // Abort previous controller to clean up stale listeners from View Transitions
    window.__mobileMenuController?.abort();
    const controller = new AbortController();
    window.__mobileMenuController = controller;

    const hamburgerIcon = button.querySelector('.hamburger-icon') as HTMLElement | null;
    const closeIcon = button.querySelector('.close-icon') as HTMLElement | null;

    if (!hamburgerIcon || !closeIcon) {
      return;
    }

    const refs = {
      button,
      menu,
      hamburgerIcon,
      closeIcon,
    } as const;

    function openMenu() {
      refs.button.setAttribute('aria-expanded', 'true');
      refs.button.setAttribute('aria-label', 'Close main menu');
      refs.hamburgerIcon.classList.add('hidden');
      refs.closeIcon.classList.remove('hidden');
      refs.menu.classList.remove('hidden');

      // Focus first link for accessibility
      const firstLink = refs.menu.querySelector('a');
      firstLink?.focus();
    }

    function closeMenu() {
      refs.button.setAttribute('aria-expanded', 'false');
      refs.button.setAttribute('aria-label', 'Open main menu');
      refs.hamburgerIcon.classList.remove('hidden');
      refs.closeIcon.classList.add('hidden');
      refs.menu.classList.add('hidden');
    }

    function toggleMenu() {
      const isExpanded = refs.button.getAttribute('aria-expanded') === 'true';
      if (isExpanded) {
        closeMenu();
      } else {
        openMenu();
      }
    }

    function handleEscapeKey(event: KeyboardEvent) {
      if (event.key === 'Escape' && refs.button.getAttribute('aria-expanded') === 'true') {
        closeMenu();
        refs.button.focus();
      }
    }

    function handleClickOutside(event: MouseEvent) {
      const target = event.target as Node;
      const header = refs.button.closest('header');
      if (header && !header.contains(target) && refs.button.getAttribute('aria-expanded') === 'true') {
        closeMenu();
      }
    }

    // Toggle on button click
    refs.button.addEventListener('click', toggleMenu, { signal: controller.signal });

    // Close menu when clicking a link using event delegation
    refs.menu.addEventListener('click', (event) => {
      const target = event.target as HTMLElement;
      if (target.closest('.mobile-nav-link')) {
        closeMenu();
      }
    }, { signal: controller.signal });

    // Document-level listeners with AbortController for proper cleanup
    document.addEventListener('keydown', handleEscapeKey, { signal: controller.signal });
    document.addEventListener('click', handleClickOutside, { signal: controller.signal });
  }

  // Initialize immediately for standard page loads (without View Transitions)
  initMobileMenu();

  // Re-initialize on View Transitions navigation (when enabled)
  document.addEventListener('astro:page-load', initMobileMenu);
</script>
